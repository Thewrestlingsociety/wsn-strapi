{"version":3,"file":"permission-fields.js","sources":["../../../../../../../server/src/services/permission/permissions-manager/permission-fields.ts"],"sourcesContent":["import { detectSubjectType } from '@casl/ability';\nimport { permittedFieldsOf } from '@casl/ability/extra';\nimport { isEmpty, isNil, flatMap, some, prop } from 'lodash/fp';\n\nimport type { Ability } from '@casl/ability';\n\nexport interface PermissionFieldsResult {\n  permittedFields: string[];\n  hasAtLeastOneRegistered: boolean;\n  shouldIncludeAll: boolean;\n}\n\n/**\n * Creates a cached permission fields calculator for a given CASL ability.\n *\n * The cache stores permission field calculations per action+subjectType combination.\n * Results are only cached when rules have no entity-specific conditions, as those\n * must be computed per entity.\n *\n * @param ability - The CASL ability instance to use for permission checks\n * @returns Object with getPermissionFields function and cache\n */\nexport const createPermissionFieldsCache = (ability: Ability) => {\n  const permissionCache = new Map<string, PermissionFieldsResult>();\n\n  const getPermissionFields = (actionOverride: string, subject: any): PermissionFieldsResult => {\n    const subjectType = detectSubjectType(subject);\n    const rules = ability.rulesFor(actionOverride, subjectType);\n\n    // Check if any rule has conditions that depend on entity data\n    // If so, we can't cache - must compute per entity\n    const hasEntityConditions = rules.some(\n      (rule: any) => rule.conditions && !isEmpty(rule.conditions)\n    );\n\n    // Return cached result if available and safe to use\n    const cacheKey = `${actionOverride}::${String(subjectType)}`;\n    if (!hasEntityConditions && permissionCache.has(cacheKey)) {\n      return permissionCache.get(cacheKey)!;\n    }\n\n    // Compute permission fields (expensive CASL operation)\n    const permittedFields = permittedFieldsOf(ability, actionOverride, subject, {\n      fieldsFrom: (rule) => rule.fields || [],\n    });\n\n    const hasAtLeastOneRegistered = some(\n      (fields) => !isNil(fields),\n      flatMap(prop('fields'), rules)\n    );\n    const shouldIncludeAll = isEmpty(permittedFields) && !hasAtLeastOneRegistered;\n\n    const result: PermissionFieldsResult = {\n      permittedFields,\n      hasAtLeastOneRegistered,\n      shouldIncludeAll,\n    };\n\n    // Cache for reuse if no entity-specific conditions\n    if (!hasEntityConditions) {\n      permissionCache.set(cacheKey, result);\n    }\n\n    return result;\n  };\n\n  return {\n    getPermissionFields,\n    clearCache: () => permissionCache.clear(),\n  };\n};\n"],"names":["createPermissionFieldsCache","ability","permissionCache","Map","getPermissionFields","actionOverride","subject","subjectType","detectSubjectType","rules","rulesFor","hasEntityConditions","some","rule","conditions","isEmpty","cacheKey","String","has","get","permittedFields","permittedFieldsOf","fieldsFrom","fields","hasAtLeastOneRegistered","isNil","flatMap","prop","shouldIncludeAll","result","set","clearCache","clear"],"mappings":";;;;;;AAYA;;;;;;;;;IAUaA,MAAAA,2BAAAA,GAA8B,CAACC,SAAAA,GAAAA;AAC1C,IAAA,MAAMC,kBAAkB,IAAIC,GAAAA,EAAAA;IAE5B,MAAMC,mBAAAA,GAAsB,CAACC,cAAwBC,EAAAA,OAAAA,GAAAA;AACnD,QAAA,MAAMC,cAAcC,yBAAkBF,CAAAA,OAAAA,CAAAA;AACtC,QAAA,MAAMG,KAAQR,GAAAA,SAAAA,CAAQS,QAAQ,CAACL,cAAgBE,EAAAA,WAAAA,CAAAA;;;AAI/C,QAAA,MAAMI,mBAAsBF,GAAAA,KAAAA,CAAMG,IAAI,CACpC,CAACC,IAAAA,GAAcA,IAAKC,CAAAA,UAAU,IAAI,CAACC,UAAQF,CAAAA,IAAAA,CAAKC,UAAU,CAAA,CAAA;;AAI5D,QAAA,MAAME,WAAW,CAAGX,EAAAA,cAAAA,CAAe,EAAE,EAAEY,OAAOV,WAAc,CAAA,CAAA,CAAA;AAC5D,QAAA,IAAI,CAACI,mBAAAA,IAAuBT,eAAgBgB,CAAAA,GAAG,CAACF,QAAW,CAAA,EAAA;YACzD,OAAOd,eAAAA,CAAgBiB,GAAG,CAACH,QAAAA,CAAAA;AAC7B;;AAGA,QAAA,MAAMI,eAAkBC,GAAAA,uBAAAA,CAAkBpB,SAASI,EAAAA,cAAAA,EAAgBC,OAAS,EAAA;AAC1EgB,YAAAA,UAAAA,EAAY,CAACT,IAAAA,GAASA,IAAKU,CAAAA,MAAM,IAAI;AACvC,SAAA,CAAA;QAEA,MAAMC,uBAAAA,GAA0BZ,QAC9B,CAACW,MAAAA,GAAW,CAACE,QAAMF,CAAAA,MAAAA,CAAAA,EACnBG,UAAQC,CAAAA,OAAAA,CAAK,QAAWlB,CAAAA,EAAAA,KAAAA,CAAAA,CAAAA;QAE1B,MAAMmB,gBAAAA,GAAmBb,UAAQK,CAAAA,eAAAA,CAAAA,IAAoB,CAACI,uBAAAA;AAEtD,QAAA,MAAMK,MAAiC,GAAA;AACrCT,YAAAA,eAAAA;AACAI,YAAAA,uBAAAA;AACAI,YAAAA;AACF,SAAA;;AAGA,QAAA,IAAI,CAACjB,mBAAqB,EAAA;YACxBT,eAAgB4B,CAAAA,GAAG,CAACd,QAAUa,EAAAA,MAAAA,CAAAA;AAChC;QAEA,OAAOA,MAAAA;AACT,KAAA;IAEA,OAAO;AACLzB,QAAAA,mBAAAA;QACA2B,UAAY,EAAA,IAAM7B,gBAAgB8B,KAAK;AACzC,KAAA;AACF;;;;"}