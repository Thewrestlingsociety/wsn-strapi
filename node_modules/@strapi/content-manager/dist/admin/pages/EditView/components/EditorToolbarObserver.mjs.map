{"version":3,"file":"EditorToolbarObserver.mjs","sources":["../../../../../admin/src/pages/EditView/components/EditorToolbarObserver.tsx"],"sourcesContent":["import * as React from 'react';\n\nimport { useElementOnScreen } from '@strapi/admin/strapi-admin';\nimport { Box, IconButton, Menu } from '@strapi/design-system';\nimport { More } from '@strapi/icons';\nimport { useIntl } from 'react-intl';\nimport { styled } from 'styled-components';\n\n/* -------------------------------------------------------------------------------------------------\n * ObservedToolbarComponent\n * -----------------------------------------------------------------------------------------------*/\n\ninterface ObservedToolbarComponentProps {\n  index: number;\n  lastVisibleIndex: number;\n  setLastVisibleIndex: React.Dispatch<React.SetStateAction<number>>;\n  rootRef: React.RefObject<HTMLElement>;\n  children: React.ReactNode;\n}\n\nconst ObservedToolbarComponent = ({\n  index,\n  lastVisibleIndex,\n  setLastVisibleIndex,\n  rootRef,\n  children,\n}: ObservedToolbarComponentProps) => {\n  const isVisible = index <= lastVisibleIndex;\n\n  const containerRef = useElementOnScreen<HTMLDivElement>(\n    (isVisible) => {\n      /**\n       * It's the MoreMenu's job to make an item not visible when there's not room for it.\n       * But we need to react here to the element becoming visible again.\n       */\n      if (isVisible) {\n        setLastVisibleIndex((prev) => Math.max(prev, index));\n      }\n    },\n    { threshold: 1, root: rootRef.current }\n  );\n\n  return (\n    <div\n      ref={containerRef}\n      style={{\n        /**\n         * Use visibility so that the element occupies the space if requires even when there's not\n         * enough room for it to be visible. The empty reserved space will be clipped by the\n         * overflow:hidden rule on the parent, so it doesn't affect the UI.\n         * This way we can keep observing its visiblity and react to browser resize events.\n         */\n        visibility: isVisible ? 'visible' : 'hidden',\n      }}\n    >\n      {children}\n    </div>\n  );\n};\n\n/* -------------------------------------------------------------------------------------------------\n * EditorToolbarObserver\n * -----------------------------------------------------------------------------------------------*/\n\nexport interface ObservedComponent {\n  toolbar: React.ReactNode;\n  menu: React.ReactNode;\n  key: string;\n}\n\n/* -------------------------------------------------------------------------------------------------\n * MenuTriggerWrapper\n * -----------------------------------------------------------------------------------------------*/\n/**\n * The menu trigger is rendered by the observer, after the last visible toolbar item.\n * We use a wrapper with a ::before pseudo-element to render a vertical separator that\n * always appears immediately before the \"More\" menu button, regardless of which items\n * are visible or moved into the overflow menu.\n */\nconst MenuTriggerWrapper = styled(Box)`\n  display: flex;\n  align-items: center;\n\n  &::before {\n    content: '';\n    background: ${({ theme }) => theme.colors.neutral150};\n    width: 1px;\n    height: 2.4rem;\n    margin-left: ${({ theme }) => theme.spaces[1]};\n    margin-right: ${({ theme }) => theme.spaces[1]};\n\n    ${({ theme }) => theme.breakpoints.medium} {\n      margin-left: ${({ theme }) => theme.spaces[2]};\n      margin-right: ${({ theme }) => theme.spaces[2]};\n    }\n  }\n\n  [data-hide-toolbar-separator='true'] &::before {\n    display: none;\n  }\n`;\n\nexport const EditorToolbarObserver = ({\n  observedComponents,\n  menuTriggerVariant = 'ghost',\n}: {\n  observedComponents: ObservedComponent[];\n  menuTriggerVariant?: Menu.TriggerProps['variant'];\n}) => {\n  const { formatMessage } = useIntl();\n  const toolbarRef = React.useRef<HTMLElement>(null);\n\n  const [lastVisibleIndex, setLastVisibleIndex] = React.useState<number>(\n    observedComponents.length - 1\n  );\n  const hasHiddenItems = lastVisibleIndex < observedComponents.length - 1;\n  const menuIndex = lastVisibleIndex + 1;\n\n  const [open, setOpen] = React.useState(false);\n  const isMenuOpenWithContent = open && hasHiddenItems;\n  const menuTriggerRef = useElementOnScreen<HTMLButtonElement>(\n    (isVisible) => {\n      // We only react to the menu becoming invisible. When that happens, we hide the last item.\n      if (!isVisible) {\n        /**\n         * If there's no room for any item, the index can be -1.\n         * This is intentional, in that case only the more menu will be visible.\n         **/\n        setLastVisibleIndex((prev) => prev - 1);\n        // Maintain the menu state if it has content\n        setOpen(isMenuOpenWithContent);\n      }\n    },\n    { threshold: 1, root: toolbarRef.current }\n  );\n\n  return observedComponents\n    .map((component, index) => {\n      return (\n        <ObservedToolbarComponent\n          key={component.key}\n          index={index}\n          lastVisibleIndex={lastVisibleIndex}\n          setLastVisibleIndex={setLastVisibleIndex}\n          rootRef={toolbarRef}\n        >\n          {component.toolbar}\n        </ObservedToolbarComponent>\n      );\n    })\n    .toSpliced(\n      menuIndex,\n      0,\n      <MenuTriggerWrapper\n        key=\"more-menu-wrapper\"\n        style={{ visibility: hasHiddenItems ? 'visible' : 'hidden' }}\n      >\n        <Menu.Root defaultOpen={false} open={isMenuOpenWithContent} onOpenChange={setOpen}>\n          <Menu.Trigger\n            paddingLeft={0}\n            paddingRight={0}\n            ref={menuTriggerRef}\n            variant={menuTriggerVariant}\n            label={formatMessage({ id: 'global.more', defaultMessage: 'More' })}\n            tag={IconButton}\n            icon={<More />}\n          />\n          <Menu.Content\n            onCloseAutoFocus={(e) => e.preventDefault()}\n            maxHeight=\"100%\"\n            minWidth=\"256px\"\n            popoverPlacement=\"bottom-end\"\n            zIndex={2}\n          >\n            {observedComponents.slice(menuIndex).map((component) => (\n              <React.Fragment key={component.key}>{component.menu}</React.Fragment>\n            ))}\n          </Menu.Content>\n        </Menu.Root>\n      </MenuTriggerWrapper>\n    );\n};\n"],"names":["ObservedToolbarComponent","index","lastVisibleIndex","setLastVisibleIndex","rootRef","children","isVisible","containerRef","useElementOnScreen","prev","Math","max","threshold","root","current","_jsx","div","ref","style","visibility","MenuTriggerWrapper","styled","Box","theme","colors","neutral150","spaces","breakpoints","medium","EditorToolbarObserver","observedComponents","menuTriggerVariant","formatMessage","useIntl","toolbarRef","React","useRef","useState","length","hasHiddenItems","menuIndex","open","setOpen","isMenuOpenWithContent","menuTriggerRef","map","component","toolbar","key","toSpliced","_jsxs","Menu","Root","defaultOpen","onOpenChange","Trigger","paddingLeft","paddingRight","variant","label","id","defaultMessage","tag","IconButton","icon","More","Content","onCloseAutoFocus","e","preventDefault","maxHeight","minWidth","popoverPlacement","zIndex","slice","Fragment","menu"],"mappings":"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"}