{"version":3,"file":"Modifiers.mjs","sources":["../../../../../../../admin/src/pages/EditView/components/FormInputs/BlocksInput/Modifiers.tsx"],"sourcesContent":["import * as React from 'react';\n\nimport { Typography, TypographyComponent } from '@strapi/design-system';\nimport { Bold, Italic, Underline, StrikeThrough, Code } from '@strapi/icons';\nimport { type MessageDescriptor } from 'react-intl';\nimport { Editor, type NodeEntry, Range, Text, Transforms } from 'slate';\nimport { styled, css } from 'styled-components';\n\nconst stylesToInherit = css`\n  font-size: inherit;\n  color: inherit;\n  line-height: inherit;\n`;\n\nconst BoldText = styled<TypographyComponent>(Typography).attrs({ fontWeight: 'bold' })`\n  ${stylesToInherit}\n`;\n\nconst ItalicText = styled<TypographyComponent>(Typography)`\n  font-style: italic;\n  ${stylesToInherit}\n`;\n\nconst UnderlineText = styled<TypographyComponent>(Typography).attrs({\n  textDecoration: 'underline',\n})`\n  ${stylesToInherit}\n`;\n\nconst StrikeThroughText = styled<TypographyComponent>(Typography).attrs({\n  textDecoration: 'line-through',\n})`\n  ${stylesToInherit}\n`;\n\nconst InlineCode = styled.code`\n  background-color: ${({ theme }) => theme.colors.neutral150};\n  border-radius: ${({ theme }) => theme.borderRadius};\n  padding: ${({ theme }) => `0 ${theme.spaces[2]}`};\n  font-family: 'SF Mono', SFMono-Regular, ui-monospace, 'DejaVu Sans Mono', Menlo, Consolas,\n    monospace;\n  color: inherit;\n`;\n\ntype ModifierKey = Exclude<keyof Text, 'type' | 'text'>;\n\ntype ModifiersStore = {\n  [K in ModifierKey]: {\n    icon: React.ComponentType;\n    isValidEventKey: (event: React.KeyboardEvent<HTMLElement>) => boolean;\n    label: MessageDescriptor;\n    checkIsActive: (editor: Editor) => boolean;\n    handleToggle: (editor: Editor) => void;\n    renderLeaf: (children: React.JSX.Element | string) => React.JSX.Element;\n  };\n};\n\n/**\n * The default handler for checking if a modifier is active\n */\nconst baseCheckIsActive = (editor: Editor, name: ModifierKey) => {\n  const { selection } = editor;\n\n  // If there's no selection, fall back to Slate's current marks.\n  // (This is what will be applied to newly inserted text.)\n  if (!selection) {\n    const marks = Editor.marks(editor);\n    return Boolean(marks?.[name]);\n  }\n\n  // Collapsed selection (caret): current marks are reliable.\n  if (Range.isCollapsed(selection)) {\n    const marks = Editor.marks(editor);\n    return Boolean(marks?.[name]);\n  }\n\n  /**\n   * Expanded selection: derive \"active\" state from the selected text nodes.\n   *\n   * This avoids a common mobile edge case where the selection focus can sit just\n   * outside the formatted span (so relying on caret/focus marks would be wrong).\n   *\n   * Additionally, mobile selection often includes an extra whitespace character at\n   * the edge (e.g. the trailing space after a word). We ignore whitespace-only\n   * portions when computing active state so the toolbar reflects the intended\n   * formatted text.\n   */\n  const range = Editor.unhangRange(editor, selection);\n  const selectedTextEntries = Array.from(\n    Editor.nodes(editor, { at: range, match: Text.isText, mode: 'all' })\n  ) as NodeEntry<Text>[];\n\n  if (selectedTextEntries.length === 0) return false;\n\n  const summary = selectedTextEntries.reduce(\n    (acc, [node, path]) => {\n      const nodeRange = Editor.range(editor, path);\n      const intersection = Range.intersection(range, nodeRange);\n\n      if (!intersection) {\n        return acc;\n      }\n\n      const start = Math.min(intersection.anchor.offset, intersection.focus.offset);\n      const end = Math.max(intersection.anchor.offset, intersection.focus.offset);\n      const selectedSlice = node.text.slice(start, end);\n\n      // Ignore whitespace-only slices (common in mobile selection boundaries).\n      if (selectedSlice.trim().length === 0) {\n        return acc;\n      }\n\n      return {\n        hasNonWhitespaceSelection: true,\n        isEveryRelevantNodeMarked: acc.isEveryRelevantNodeMarked && Boolean(node[name]),\n      };\n    },\n    { hasNonWhitespaceSelection: false, isEveryRelevantNodeMarked: true }\n  );\n\n  return summary.hasNonWhitespaceSelection && summary.isEveryRelevantNodeMarked;\n};\n\n/**\n * The default handler for toggling a modifier\n */\nconst baseHandleToggle = (editor: Editor, name: ModifierKey) => {\n  // If there is no selection, set selection to the end of line\n  if (!editor.selection) {\n    const endOfEditor = Editor.end(editor, []);\n    Transforms.select(editor, endOfEditor);\n  }\n\n  // Toggle the modifier\n  if (baseCheckIsActive(editor, name)) {\n    Editor.removeMark(editor, name);\n  } else {\n    Editor.addMark(editor, name, true);\n  }\n};\n\nconst modifiers: ModifiersStore = {\n  bold: {\n    icon: Bold,\n    isValidEventKey: (event) => event.key === 'b',\n    label: { id: 'components.Blocks.modifiers.bold', defaultMessage: 'Bold' },\n    checkIsActive: (editor) => baseCheckIsActive(editor, 'bold'),\n    handleToggle: (editor) => baseHandleToggle(editor, 'bold'),\n    renderLeaf: (children) => <BoldText>{children}</BoldText>,\n  },\n  italic: {\n    icon: Italic,\n    isValidEventKey: (event) => event.key === 'i',\n    label: { id: 'components.Blocks.modifiers.italic', defaultMessage: 'Italic' },\n    checkIsActive: (editor) => baseCheckIsActive(editor, 'italic'),\n    handleToggle: (editor) => baseHandleToggle(editor, 'italic'),\n    renderLeaf: (children) => <ItalicText>{children}</ItalicText>,\n  },\n  underline: {\n    icon: Underline,\n    isValidEventKey: (event) => event.key === 'u',\n    label: { id: 'components.Blocks.modifiers.underline', defaultMessage: 'Underline' },\n    checkIsActive: (editor) => baseCheckIsActive(editor, 'underline'),\n    handleToggle: (editor) => baseHandleToggle(editor, 'underline'),\n    renderLeaf: (children) => <UnderlineText>{children}</UnderlineText>,\n  },\n  strikethrough: {\n    icon: StrikeThrough,\n    isValidEventKey: (event) => event.key === 'S' && event.shiftKey,\n    label: { id: 'components.Blocks.modifiers.strikethrough', defaultMessage: 'Strikethrough' },\n    checkIsActive: (editor) => baseCheckIsActive(editor, 'strikethrough'),\n    handleToggle: (editor) => baseHandleToggle(editor, 'strikethrough'),\n    renderLeaf: (children) => <StrikeThroughText>{children}</StrikeThroughText>,\n  },\n  code: {\n    icon: Code,\n    isValidEventKey: (event) => event.key === 'e',\n    label: { id: 'components.Blocks.modifiers.code', defaultMessage: 'Inline code' },\n    checkIsActive: (editor) => baseCheckIsActive(editor, 'code'),\n    handleToggle: (editor) => baseHandleToggle(editor, 'code'),\n    renderLeaf: (children) => <InlineCode>{children}</InlineCode>,\n  },\n};\n\nexport { type ModifiersStore, modifiers };\n"],"names":["stylesToInherit","css","BoldText","styled","Typography","attrs","fontWeight","ItalicText","UnderlineText","textDecoration","StrikeThroughText","InlineCode","code","theme","colors","neutral150","borderRadius","spaces","baseCheckIsActive","editor","name","selection","marks","Editor","Boolean","Range","isCollapsed","range","unhangRange","selectedTextEntries","Array","from","nodes","at","match","Text","isText","mode","length","summary","reduce","acc","node","path","nodeRange","intersection","start","Math","min","anchor","offset","focus","end","max","selectedSlice","text","slice","trim","hasNonWhitespaceSelection","isEveryRelevantNodeMarked","baseHandleToggle","endOfEditor","Transforms","select","removeMark","addMark","modifiers","bold","icon","Bold","isValidEventKey","event","key","label","id","defaultMessage","checkIsActive","handleToggle","renderLeaf","children","_jsx","italic","Italic","underline","Underline","strikethrough","StrikeThrough","shiftKey","Code"],"mappings":";;;;;;;AAQA,MAAMA,eAAAA,GAAkBC,GAAG;;;;AAI3B,CAAC;AAED,MAAMC,QAAWC,GAAAA,MAAAA,CAA4BC,UAAYC,CAAAA,CAAAA,KAAK,CAAC;IAAEC,UAAY,EAAA;AAAO,CAAA,CAAE;AACpF,EAAA,EAAEN,eAAgB;AACpB,CAAC;AAED,MAAMO,UAAAA,GAAaJ,MAA4BC,CAAAA,UAAAA,CAAW;;AAExD,EAAA,EAAEJ,eAAgB;AACpB,CAAC;AAED,MAAMQ,aAAgBL,GAAAA,MAAAA,CAA4BC,UAAYC,CAAAA,CAAAA,KAAK,CAAC;IAClEI,cAAgB,EAAA;AAClB,CAAA,CAAE;AACA,EAAA,EAAET,eAAgB;AACpB,CAAC;AAED,MAAMU,iBAAoBP,GAAAA,MAAAA,CAA4BC,UAAYC,CAAAA,CAAAA,KAAK,CAAC;IACtEI,cAAgB,EAAA;AAClB,CAAA,CAAE;AACA,EAAA,EAAET,eAAgB;AACpB,CAAC;AAED,MAAMW,UAAAA,GAAaR,MAAOS,CAAAA,IAAI;oBACV,EAAE,CAAC,EAAEC,KAAK,EAAE,GAAKA,KAAMC,CAAAA,MAAM,CAACC,UAAU,CAAC;AAC5C,iBAAA,EAAE,CAAC,EAAEF,KAAK,EAAE,GAAKA,KAAAA,CAAMG,YAAY,CAAC;AAC1C,WAAA,EAAE,CAAC,EAAEH,KAAK,EAAE,GAAK,CAAC,EAAE,EAAEA,KAAMI,CAAAA,MAAM,CAAC,CAAA,CAAE,EAAE,CAAC;;;;AAInD,CAAC;AAeD;;IAGA,MAAMC,iBAAoB,GAAA,CAACC,MAAgBC,EAAAA,IAAAA,GAAAA;IACzC,MAAM,EAAEC,SAAS,EAAE,GAAGF,MAAAA;;;AAItB,IAAA,IAAI,CAACE,SAAW,EAAA;QACd,MAAMC,KAAAA,GAAQC,MAAOD,CAAAA,KAAK,CAACH,MAAAA,CAAAA;QAC3B,OAAOK,OAAAA,CAAQF,KAAO,GAACF,IAAK,CAAA,CAAA;AAC9B;;IAGA,IAAIK,KAAAA,CAAMC,WAAW,CAACL,SAAY,CAAA,EAAA;QAChC,MAAMC,KAAAA,GAAQC,MAAOD,CAAAA,KAAK,CAACH,MAAAA,CAAAA;QAC3B,OAAOK,OAAAA,CAAQF,KAAO,GAACF,IAAK,CAAA,CAAA;AAC9B;AAEA;;;;;;;;;;AAUC,MACD,MAAMO,KAAAA,GAAQJ,MAAOK,CAAAA,WAAW,CAACT,MAAQE,EAAAA,SAAAA,CAAAA;AACzC,IAAA,MAAMQ,sBAAsBC,KAAMC,CAAAA,IAAI,CACpCR,MAAOS,CAAAA,KAAK,CAACb,MAAQ,EAAA;QAAEc,EAAIN,EAAAA,KAAAA;AAAOO,QAAAA,KAAAA,EAAOC,KAAKC,MAAM;QAAEC,IAAM,EAAA;AAAM,KAAA,CAAA,CAAA;AAGpE,IAAA,IAAIR,mBAAoBS,CAAAA,MAAM,KAAK,CAAA,EAAG,OAAO,KAAA;IAE7C,MAAMC,OAAAA,GAAUV,oBAAoBW,MAAM,CACxC,CAACC,GAAK,EAAA,CAACC,MAAMC,IAAK,CAAA,GAAA;AAChB,QAAA,MAAMC,SAAYrB,GAAAA,MAAAA,CAAOI,KAAK,CAACR,MAAQwB,EAAAA,IAAAA,CAAAA;AACvC,QAAA,MAAME,YAAepB,GAAAA,KAAAA,CAAMoB,YAAY,CAAClB,KAAOiB,EAAAA,SAAAA,CAAAA;AAE/C,QAAA,IAAI,CAACC,YAAc,EAAA;YACjB,OAAOJ,GAAAA;AACT;AAEA,QAAA,MAAMK,KAAQC,GAAAA,IAAAA,CAAKC,GAAG,CAACH,YAAaI,CAAAA,MAAM,CAACC,MAAM,EAAEL,YAAAA,CAAaM,KAAK,CAACD,MAAM,CAAA;AAC5E,QAAA,MAAME,GAAML,GAAAA,IAAAA,CAAKM,GAAG,CAACR,YAAaI,CAAAA,MAAM,CAACC,MAAM,EAAEL,YAAAA,CAAaM,KAAK,CAACD,MAAM,CAAA;AAC1E,QAAA,MAAMI,gBAAgBZ,IAAKa,CAAAA,IAAI,CAACC,KAAK,CAACV,KAAOM,EAAAA,GAAAA,CAAAA;;AAG7C,QAAA,IAAIE,aAAcG,CAAAA,IAAI,EAAGnB,CAAAA,MAAM,KAAK,CAAG,EAAA;YACrC,OAAOG,GAAAA;AACT;QAEA,OAAO;YACLiB,yBAA2B,EAAA,IAAA;AAC3BC,YAAAA,yBAAAA,EAA2BlB,IAAIkB,yBAAyB,IAAInC,OAAQkB,CAAAA,IAAI,CAACtB,IAAK,CAAA;AAChF,SAAA;KAEF,EAAA;QAAEsC,yBAA2B,EAAA,KAAA;QAAOC,yBAA2B,EAAA;AAAK,KAAA,CAAA;AAGtE,IAAA,OAAOpB,OAAQmB,CAAAA,yBAAyB,IAAInB,OAAAA,CAAQoB,yBAAyB;AAC/E,CAAA;AAEA;;IAGA,MAAMC,gBAAmB,GAAA,CAACzC,MAAgBC,EAAAA,IAAAA,GAAAA;;IAExC,IAAI,CAACD,MAAOE,CAAAA,SAAS,EAAE;AACrB,QAAA,MAAMwC,WAActC,GAAAA,MAAAA,CAAO6B,GAAG,CAACjC,QAAQ,EAAE,CAAA;QACzC2C,UAAWC,CAAAA,MAAM,CAAC5C,MAAQ0C,EAAAA,WAAAA,CAAAA;AAC5B;;IAGA,IAAI3C,iBAAAA,CAAkBC,QAAQC,IAAO,CAAA,EAAA;QACnCG,MAAOyC,CAAAA,UAAU,CAAC7C,MAAQC,EAAAA,IAAAA,CAAAA;KACrB,MAAA;QACLG,MAAO0C,CAAAA,OAAO,CAAC9C,MAAAA,EAAQC,IAAM,EAAA,IAAA,CAAA;AAC/B;AACF,CAAA;AAEA,MAAM8C,SAA4B,GAAA;IAChCC,IAAM,EAAA;QACJC,IAAMC,EAAAA,IAAAA;AACNC,QAAAA,eAAAA,EAAiB,CAACC,KAAAA,GAAUA,KAAMC,CAAAA,GAAG,KAAK,GAAA;QAC1CC,KAAO,EAAA;YAAEC,EAAI,EAAA,kCAAA;YAAoCC,cAAgB,EAAA;AAAO,SAAA;QACxEC,aAAe,EAAA,CAACzD,MAAWD,GAAAA,iBAAAA,CAAkBC,MAAQ,EAAA,MAAA,CAAA;QACrD0D,YAAc,EAAA,CAAC1D,MAAWyC,GAAAA,gBAAAA,CAAiBzC,MAAQ,EAAA,MAAA,CAAA;QACnD2D,UAAY,EAAA,CAACC,yBAAaC,GAAC9E,CAAAA,QAAAA,EAAAA;AAAU6E,gBAAAA,QAAAA,EAAAA;;AACvC,KAAA;IACAE,MAAQ,EAAA;QACNb,IAAMc,EAAAA,MAAAA;AACNZ,QAAAA,eAAAA,EAAiB,CAACC,KAAAA,GAAUA,KAAMC,CAAAA,GAAG,KAAK,GAAA;QAC1CC,KAAO,EAAA;YAAEC,EAAI,EAAA,oCAAA;YAAsCC,cAAgB,EAAA;AAAS,SAAA;QAC5EC,aAAe,EAAA,CAACzD,MAAWD,GAAAA,iBAAAA,CAAkBC,MAAQ,EAAA,QAAA,CAAA;QACrD0D,YAAc,EAAA,CAAC1D,MAAWyC,GAAAA,gBAAAA,CAAiBzC,MAAQ,EAAA,QAAA,CAAA;QACnD2D,UAAY,EAAA,CAACC,yBAAaC,GAACzE,CAAAA,UAAAA,EAAAA;AAAYwE,gBAAAA,QAAAA,EAAAA;;AACzC,KAAA;IACAI,SAAW,EAAA;QACTf,IAAMgB,EAAAA,SAAAA;AACNd,QAAAA,eAAAA,EAAiB,CAACC,KAAAA,GAAUA,KAAMC,CAAAA,GAAG,KAAK,GAAA;QAC1CC,KAAO,EAAA;YAAEC,EAAI,EAAA,uCAAA;YAAyCC,cAAgB,EAAA;AAAY,SAAA;QAClFC,aAAe,EAAA,CAACzD,MAAWD,GAAAA,iBAAAA,CAAkBC,MAAQ,EAAA,WAAA,CAAA;QACrD0D,YAAc,EAAA,CAAC1D,MAAWyC,GAAAA,gBAAAA,CAAiBzC,MAAQ,EAAA,WAAA,CAAA;QACnD2D,UAAY,EAAA,CAACC,yBAAaC,GAACxE,CAAAA,aAAAA,EAAAA;AAAeuE,gBAAAA,QAAAA,EAAAA;;AAC5C,KAAA;IACAM,aAAe,EAAA;QACbjB,IAAMkB,EAAAA,aAAAA;AACNhB,QAAAA,eAAAA,EAAiB,CAACC,KAAUA,GAAAA,KAAAA,CAAMC,GAAG,KAAK,GAAA,IAAOD,MAAMgB,QAAQ;QAC/Dd,KAAO,EAAA;YAAEC,EAAI,EAAA,2CAAA;YAA6CC,cAAgB,EAAA;AAAgB,SAAA;QAC1FC,aAAe,EAAA,CAACzD,MAAWD,GAAAA,iBAAAA,CAAkBC,MAAQ,EAAA,eAAA,CAAA;QACrD0D,YAAc,EAAA,CAAC1D,MAAWyC,GAAAA,gBAAAA,CAAiBzC,MAAQ,EAAA,eAAA,CAAA;QACnD2D,UAAY,EAAA,CAACC,yBAAaC,GAACtE,CAAAA,iBAAAA,EAAAA;AAAmBqE,gBAAAA,QAAAA,EAAAA;;AAChD,KAAA;IACAnE,IAAM,EAAA;QACJwD,IAAMoB,EAAAA,IAAAA;AACNlB,QAAAA,eAAAA,EAAiB,CAACC,KAAAA,GAAUA,KAAMC,CAAAA,GAAG,KAAK,GAAA;QAC1CC,KAAO,EAAA;YAAEC,EAAI,EAAA,kCAAA;YAAoCC,cAAgB,EAAA;AAAc,SAAA;QAC/EC,aAAe,EAAA,CAACzD,MAAWD,GAAAA,iBAAAA,CAAkBC,MAAQ,EAAA,MAAA,CAAA;QACrD0D,YAAc,EAAA,CAAC1D,MAAWyC,GAAAA,gBAAAA,CAAiBzC,MAAQ,EAAA,MAAA,CAAA;QACnD2D,UAAY,EAAA,CAACC,yBAAaC,GAACrE,CAAAA,UAAAA,EAAAA;AAAYoE,gBAAAA,QAAAA,EAAAA;;AACzC;AACF;;;;"}