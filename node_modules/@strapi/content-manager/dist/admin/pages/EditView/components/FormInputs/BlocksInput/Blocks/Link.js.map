{"version":3,"file":"Link.js","sources":["../../../../../../../../admin/src/pages/EditView/components/FormInputs/BlocksInput/Blocks/Link.tsx"],"sourcesContent":["import * as React from 'react';\n\nimport { Box, Button, Field, Flex, Popover } from '@strapi/design-system';\nimport { useIntl } from 'react-intl';\nimport {\n  BaseEditor,\n  Editor,\n  Element,\n  Path,\n  Point,\n  Range,\n  Transforms,\n  Element as SlateElement,\n  Node,\n} from 'slate';\nimport { type RenderElementProps, ReactEditor } from 'slate-react';\nimport { styled } from 'styled-components';\n\nimport { type BlocksStore, useBlocksEditorContext } from '../BlocksEditor';\nimport { type Block } from '../utils/types';\n\nimport type { Schema } from '@strapi/types';\n\nconst isLinkNode = (element: Element): element is Schema.Attribute.LinkInlineNode => {\n  return element.type === 'link';\n};\n\nconst removeLink = (editor: Editor) => {\n  Transforms.unwrapNodes(editor, {\n    match: (node) => !Editor.isEditor(node) && SlateElement.isElement(node) && node.type === 'link',\n  });\n};\n\nconst insertLink = (editor: Editor, { url }: { url: string }) => {\n  if (editor.selection) {\n    // We want to remove all link on the selection\n    const linkNodes = Array.from(\n      Editor.nodes(editor, {\n        at: editor.selection,\n        match: (node) => !Editor.isEditor(node) && node.type === 'link',\n      })\n    );\n\n    linkNodes.forEach(([, path]) => {\n      Transforms.unwrapNodes(editor, { at: path });\n    });\n\n    if (Range.isCollapsed(editor.selection)) {\n      const link: Block<'link'> = {\n        type: 'link',\n        url: url ?? '',\n        children: [{ type: 'text', text: url }],\n        rel: '',\n        target: '',\n      };\n\n      Transforms.insertNodes(editor, link);\n    } else {\n      Transforms.wrapNodes(editor, { type: 'link', url: url ?? '' } as Block<'link'>, {\n        split: true,\n      });\n    }\n  }\n};\n\nconst editLink = (\n  editor: Editor,\n  link: { url: string; text: string; rel: string; target: string }\n) => {\n  const { url, text, rel, target } = link;\n\n  if (!editor.selection) {\n    return;\n  }\n\n  const linkEntry = Editor.above(editor, {\n    match: (node) => !Editor.isEditor(node) && node.type === 'link',\n  });\n\n  if (linkEntry) {\n    const [, linkPath] = linkEntry;\n    Transforms.setNodes(editor, { url, rel, target }, { at: linkPath });\n\n    // If link text is different, we remove the old text and insert the new one\n    if (text !== '' && text !== Editor.string(editor, linkPath)) {\n      const linkNodeChildrens = Array.from(Node.children(editor, linkPath, { reverse: true }));\n\n      linkNodeChildrens.forEach(([, childPath]) => {\n        Transforms.removeNodes(editor, { at: childPath });\n      });\n\n      Transforms.insertNodes(editor, [{ type: 'text', text }], { at: linkPath.concat(0) });\n    }\n  }\n};\n\nconst StyledLink = styled(Box)`\n  text-decoration: none;\n`;\n\nconst RemoveButton = styled(Button)<{ $visible: boolean }>`\n  visibility: ${(props) => (props.$visible ? 'visible' : 'hidden')};\n`;\n\ninterface LinkContentProps extends RenderElementProps {\n  link: Block<'link'>;\n}\n\nconst LinkContent = React.forwardRef<HTMLAnchorElement, LinkContentProps>(\n  ({ link, children, attributes }, forwardedRef) => {\n    const { formatMessage } = useIntl();\n    const { editor } = useBlocksEditorContext('Link');\n    const path = ReactEditor.findPath(editor, link);\n    const [popoverOpen, setPopoverOpen] = React.useState(\n      editor.lastInsertedLinkPath ? Path.equals(path, editor.lastInsertedLinkPath) : false\n    );\n    const elementText = link.children.map((child) => child.text).join('');\n    const [linkText, setLinkText] = React.useState(elementText);\n    const [linkUrl, setLinkUrl] = React.useState(link.url);\n    const [linkRel, setLinRel] = React.useState(link.rel);\n    const [linkTarget, setLinkTarget] = React.useState(link.target);\n    const linkInputRef = React.useRef<HTMLInputElement>(null);\n    const isLastInsertedLink = editor.lastInsertedLinkPath\n      ? !Path.equals(path, editor.lastInsertedLinkPath)\n      : true;\n    const [isSaveDisabled, setIsSaveDisabled] = React.useState(false);\n\n    const onLinkChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n      setIsSaveDisabled(false);\n      setLinkUrl(e.target.value);\n\n      try {\n        // eslint-disable-next-line no-new\n        new URL(\n          e.target.value?.startsWith('/') ? `https://strapi.io${e.target.value}` : e.target.value\n        );\n      } catch (error) {\n        setIsSaveDisabled(true);\n      }\n    };\n\n    const onLinkRelChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n      setIsSaveDisabled(false);\n      setLinRel(e.target.value);\n    };\n\n    const onLinkTargetChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n      setIsSaveDisabled(false);\n      setLinkTarget(e.target.value);\n    };\n\n    const handleSave: React.FormEventHandler = (e) => {\n      e.stopPropagation();\n\n      // If the selection is collapsed, we select the parent node because we want all the link to be replaced)\n      if (editor.selection && Range.isCollapsed(editor.selection)) {\n        const [, parentPath] = Editor.parent(editor, editor.selection.focus?.path);\n        Transforms.select(editor, parentPath);\n      }\n\n      editLink(editor, { url: linkUrl, text: linkText, rel: linkRel, target: linkTarget });\n      setPopoverOpen(false);\n      editor.lastInsertedLinkPath = null;\n      ReactEditor.focus(editor);\n    };\n\n    const handleClose = () => {\n      if (link.url === '') {\n        removeLink(editor);\n      }\n\n      setPopoverOpen(false);\n      ReactEditor.focus(editor);\n    };\n\n    React.useEffect(() => {\n      // Focus on the link input element when the popover opens\n      if (popoverOpen) linkInputRef.current?.focus();\n    }, [popoverOpen]);\n\n    const inputNotDirty =\n      !linkText ||\n      !linkUrl ||\n      (link.url &&\n        link.url === linkUrl &&\n        elementText &&\n        elementText === linkText &&\n        link.rel === linkRel &&\n        link.target === linkTarget);\n\n    return (\n      <Popover.Root open={popoverOpen}>\n        <Popover.Trigger>\n          <StyledLink\n            {...attributes}\n            ref={forwardedRef}\n            tag=\"a\"\n            href={link.url}\n            rel={link.rel}\n            target={link.target}\n            onClick={() => setPopoverOpen(true)}\n            color=\"primary600\"\n          >\n            {children}\n          </StyledLink>\n        </Popover.Trigger>\n        <Popover.Content onPointerDownOutside={handleClose}>\n          <Flex padding={4} direction=\"column\" gap={4}>\n            <Field.Root width={{ initial: '100%', medium: '368px' }}>\n              <Flex direction=\"column\" gap={1} alignItems=\"stretch\">\n                <Field.Label>\n                  {formatMessage({\n                    id: 'components.Blocks.popover.text',\n                    defaultMessage: 'Text',\n                  })}\n                </Field.Label>\n                <Field.Input\n                  name=\"text\"\n                  placeholder={formatMessage({\n                    id: 'components.Blocks.popover.text.placeholder',\n                    defaultMessage: 'Enter link text',\n                  })}\n                  value={linkText}\n                  onChange={(e) => {\n                    setLinkText(e.target.value);\n                  }}\n                />\n              </Flex>\n            </Field.Root>\n            <Field.Root width={{ initial: '100%', medium: '368px' }}>\n              <Flex direction=\"column\" gap={1} alignItems=\"stretch\">\n                <Field.Label>\n                  {formatMessage({\n                    id: 'components.Blocks.popover.link',\n                    defaultMessage: 'Link',\n                  })}\n                </Field.Label>\n                <Field.Input\n                  ref={linkInputRef}\n                  name=\"url\"\n                  placeholder={formatMessage({\n                    id: 'components.Blocks.popover.link.placeholder',\n                    defaultMessage: 'Paste link',\n                  })}\n                  value={linkUrl}\n                  onChange={onLinkChange}\n                />\n              </Flex>\n            </Field.Root>\n            <Field.Root width={{ initial: '100%', medium: '368px' }}>\n              <Flex direction=\"column\" gap={1} alignItems=\"stretch\">\n                <Field.Label>\n                  {formatMessage({\n                    id: 'components.Blocks.popover.link.rel',\n                    defaultMessage: 'Rel (optional)',\n                  })}\n                </Field.Label>\n                <Field.Input\n                  name=\"rel\"\n                  placeholder={formatMessage({\n                    id: 'components.Blocks.popover.link.rel.placeholder',\n                    defaultMessage: 'noopener, nofollow, noreferrer',\n                  })}\n                  value={linkRel}\n                  onChange={onLinkRelChange}\n                />\n              </Flex>\n            </Field.Root>\n            <Field.Root width={{ initial: '100%', medium: '368px' }}>\n              <Flex direction=\"column\" gap={1} alignItems=\"stretch\">\n                <Field.Label>\n                  {formatMessage({\n                    id: 'components.Blocks.popover.link.target',\n                    defaultMessage: 'Target (optional)',\n                  })}\n                </Field.Label>\n                <Field.Input\n                  name=\"target\"\n                  placeholder={formatMessage({\n                    id: 'components.Blocks.popover.link.target.placeholder',\n                    defaultMessage: '_blank, _self, _parent, _top',\n                  })}\n                  value={linkTarget}\n                  onChange={onLinkTargetChange}\n                />\n              </Flex>\n            </Field.Root>\n            <Flex justifyContent=\"space-between\" width={{ initial: '100%', medium: '368px' }}>\n              <RemoveButton\n                variant=\"danger-light\"\n                onClick={() => removeLink(editor)}\n                $visible={isLastInsertedLink}\n              >\n                {formatMessage({\n                  id: 'components.Blocks.popover.remove',\n                  defaultMessage: 'Remove',\n                })}\n              </RemoveButton>\n              <Flex gap={2}>\n                <Button variant=\"tertiary\" onClick={handleClose}>\n                  {formatMessage({\n                    id: 'global.cancel',\n                    defaultMessage: 'Cancel',\n                  })}\n                </Button>\n                <Button disabled={Boolean(inputNotDirty) || isSaveDisabled} onClick={handleSave}>\n                  {formatMessage({\n                    id: 'global.save',\n                    defaultMessage: 'Save',\n                  })}\n                </Button>\n              </Flex>\n            </Flex>\n          </Flex>\n        </Popover.Content>\n      </Popover.Root>\n    );\n  }\n);\n\nconst Link = React.forwardRef<HTMLAnchorElement, RenderElementProps>((props, forwardedRef) => {\n  if (!isLinkNode(props.element)) {\n    return null;\n  }\n\n  // LinkContent uses React hooks that rely on props.element being a link. If the type guard above\n  // doesn't pass, those hooks would be called conditionnally, which is not allowed.\n  // Hence the need for a separate component.\n  return <LinkContent {...props} link={props.element} ref={forwardedRef} />;\n});\n\nconst withLinks = (editor: Editor) => {\n  const { isInline, apply, insertText, insertData } = editor;\n\n  // Links are inline elements, so we need to override the isInline method for slate\n  editor.isInline = (element) => {\n    return element.type === 'link' ? true : isInline(element);\n  };\n\n  // We keep a track of the last inserted link path\n  // So we can show the popover on the link component if that link is the last one inserted\n  editor.lastInsertedLinkPath = null;\n\n  // We intercept the apply method, so everytime we insert a new link, we save its path\n  editor.apply = (operation) => {\n    if (operation.type === 'insert_node') {\n      if (\n        !Editor.isEditor(operation.node) &&\n        operation.node.type === 'link' &&\n        editor.shouldSaveLinkPath\n      ) {\n        editor.lastInsertedLinkPath = operation.path;\n      }\n    } else if (operation.type === 'move_node') {\n      // We need to update the last inserted link path when link is moved\n      // If link is the first word in the paragraph we dont need to update the path\n      if (\n        Path.hasPrevious(operation.path) &&\n        editor.lastInsertedLinkPath &&\n        editor.shouldSaveLinkPath\n      ) {\n        editor.lastInsertedLinkPath = Path.transform(editor.lastInsertedLinkPath, operation);\n      }\n    }\n\n    apply(operation);\n  };\n\n  editor.insertText = (text) => {\n    // When selection is at the end of a link and user types a space, we want to break the link\n    if (editor.selection && Range.isCollapsed(editor.selection) && text === ' ') {\n      const linksInSelection = Array.from(\n        Editor.nodes(editor, {\n          at: editor.selection,\n          match: (node) => !Editor.isEditor(node) && node.type === 'link',\n        })\n      );\n\n      const selectionIsInLink = editor.selection && linksInSelection.length > 0;\n      const selectionIsAtEndOfLink =\n        selectionIsInLink &&\n        Point.equals(editor.selection.anchor, Editor.end(editor, linksInSelection[0][1]));\n\n      if (selectionIsAtEndOfLink) {\n        Transforms.insertNodes(\n          editor,\n          { text: ' ', type: 'text' },\n          { at: Path.next(linksInSelection[0][1]), select: true }\n        );\n\n        return;\n      }\n    }\n\n    insertText(text);\n  };\n\n  // Add data as a clickable link if its a valid URL\n  editor.insertData = (data) => {\n    const pastedText = data.getData('text/plain');\n\n    if (pastedText) {\n      try {\n        // eslint-disable-next-line no-new\n        new URL(pastedText);\n        // Do not show link popup on copy-paste a link, so do not save its path\n        editor.shouldSaveLinkPath = false;\n        insertLink(editor, { url: pastedText });\n        return;\n      } catch (error) {\n        // continue normal data insertion\n      }\n    }\n\n    insertData(data);\n  };\n\n  return editor;\n};\n\nconst linkBlocks: Pick<BlocksStore, 'link'> = {\n  link: {\n    renderElement: (props) => (\n      <Link element={props.element} attributes={props.attributes}>\n        {props.children}\n      </Link>\n    ),\n    // No handleConvert here, links are created via the link button in the toolbar\n    matchNode: (node) => node.type === 'link',\n    isInBlocksSelector: false,\n    plugin: withLinks,\n    isDraggable: () => false,\n  },\n};\n\nexport interface LinkEditor extends BaseEditor {\n  lastInsertedLinkPath: Path | null;\n  shouldSaveLinkPath: boolean;\n}\n\nexport { linkBlocks, insertLink };\n"],"names":["isLinkNode","element","type","removeLink","editor","Transforms","unwrapNodes","match","node","Editor","isEditor","SlateElement","isElement","insertLink","url","selection","linkNodes","Array","from","nodes","at","forEach","path","Range","isCollapsed","link","children","text","rel","target","insertNodes","wrapNodes","split","editLink","linkEntry","above","linkPath","setNodes","string","linkNodeChildrens","Node","reverse","childPath","removeNodes","concat","StyledLink","styled","Box","RemoveButton","Button","props","$visible","LinkContent","React","forwardRef","attributes","forwardedRef","formatMessage","useIntl","useBlocksEditorContext","ReactEditor","findPath","popoverOpen","setPopoverOpen","useState","lastInsertedLinkPath","Path","equals","elementText","map","child","join","linkText","setLinkText","linkUrl","setLinkUrl","linkRel","setLinRel","linkTarget","setLinkTarget","linkInputRef","useRef","isLastInsertedLink","isSaveDisabled","setIsSaveDisabled","onLinkChange","e","value","URL","startsWith","error","onLinkRelChange","onLinkTargetChange","handleSave","stopPropagation","parentPath","parent","focus","select","handleClose","useEffect","current","inputNotDirty","_jsxs","Popover","Root","open","_jsx","Trigger","ref","tag","href","onClick","color","Content","onPointerDownOutside","Flex","padding","direction","gap","Field","width","initial","medium","alignItems","Label","id","defaultMessage","Input","name","placeholder","onChange","justifyContent","variant","disabled","Boolean","Link","withLinks","isInline","apply","insertText","insertData","operation","shouldSaveLinkPath","hasPrevious","transform","linksInSelection","selectionIsInLink","length","selectionIsAtEndOfLink","Point","anchor","end","next","data","pastedText","getData","linkBlocks","renderElement","matchNode","isInBlocksSelector","plugin","isDraggable"],"mappings":"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"}