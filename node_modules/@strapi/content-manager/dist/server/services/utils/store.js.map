{"version":3,"file":"store.js","sources":["../../../../server/src/services/utils/store.ts"],"sourcesContent":["import _ from 'lodash';\n\nconst keys = {\n  CONFIGURATION: 'configuration',\n};\n\nconst STORE_KEY_PREFIX = 'plugin_content_manager_';\n\nconst getStore = () => strapi.store({ type: 'plugin', name: 'content_manager' });\n\n/** Model configuration */\nconst EMPTY_CONFIG = {\n  settings: {},\n  metadatas: {},\n  layouts: { list: [], edit: [] },\n};\n\nconst configurationKey = (key: any) => `${keys.CONFIGURATION}_${key}`;\n\nconst getModelConfiguration = async (key: any) => {\n  const config = await getStore().get({ key: configurationKey(key) });\n  return _.merge({}, EMPTY_CONFIG, config);\n};\n\n/**\n * Batch load multiple model configurations in a single query.\n *\n * @param keys - Array of configuration keys (e.g., ['components::sections.hero', ...])\n * @returns Map of key -> configuration object\n */\nconst getModelConfigurations = async (keys: string[]) => {\n  if (keys.length === 0) {\n    return {};\n  }\n\n  const configKeys = keys.map((k) => `${STORE_KEY_PREFIX}${configurationKey(k)}`);\n  const results = await strapi.db.query('strapi::core-store').findMany({\n    where: {\n      key: { $in: configKeys },\n    },\n  });\n\n  const configMap: Record<string, any> = {};\n  for (const result of results) {\n    const originalKey = result.key.replace(`${STORE_KEY_PREFIX}configuration_`, '');\n    try {\n      const value = typeof result.value === 'string' ? JSON.parse(result.value) : result.value;\n      configMap[originalKey] = _.merge({}, EMPTY_CONFIG, value);\n    } catch {\n      strapi.log.warn(`Malformed JSON in core-store key \"${result.key}\", using default config`);\n    }\n  }\n\n  // Default missing keys to empty config\n  for (const key of keys) {\n    if (!configMap[key]) {\n      configMap[key] = _.merge({}, EMPTY_CONFIG);\n    }\n  }\n\n  return configMap;\n};\n\nconst setModelConfiguration = async (key: string, value: any) => {\n  const storedConfig = (await getStore().get({ key: configurationKey(key) })) || {};\n  const currentConfig = { ...storedConfig };\n\n  Object.keys(value).forEach((key) => {\n    if (value[key] !== null && value[key] !== undefined) {\n      _.set(currentConfig, key, value[key]);\n    }\n  });\n\n  if (!_.isEqual(currentConfig, storedConfig)) {\n    return getStore().set({\n      key: configurationKey(key),\n      value: currentConfig,\n    });\n  }\n};\n\nconst deleteKey = (key: any) => {\n  return strapi.db\n    .query('strapi::core-store')\n    .delete({ where: { key: `${STORE_KEY_PREFIX}configuration_${key}` } });\n};\n\nconst findByKey = async (key: any) => {\n  const results = await strapi.db.query('strapi::core-store').findMany({\n    where: {\n      key: {\n        $startsWith: key,\n      },\n    },\n  });\n\n  return results\n    .map(({ key, value }) => {\n      try {\n        return JSON.parse(value);\n      } catch {\n        strapi.log.warn(`Malformed JSON in core-store key \"${key}\", skipping entry`);\n        return null;\n      }\n    })\n    .filter((v) => v !== null);\n};\n\nconst getAllConfigurations = () => findByKey(`${STORE_KEY_PREFIX}configuration`);\n\nexport default {\n  getAllConfigurations,\n  findByKey,\n  getModelConfiguration,\n  getModelConfigurations,\n  setModelConfiguration,\n  deleteKey,\n  keys,\n};\n"],"names":["keys","CONFIGURATION","STORE_KEY_PREFIX","getStore","strapi","store","type","name","EMPTY_CONFIG","settings","metadatas","layouts","list","edit","configurationKey","key","getModelConfiguration","config","get","_","merge","getModelConfigurations","length","configKeys","map","k","results","db","query","findMany","where","$in","configMap","result","originalKey","replace","value","JSON","parse","log","warn","setModelConfiguration","storedConfig","currentConfig","Object","forEach","undefined","set","isEqual","deleteKey","delete","findByKey","$startsWith","filter","v","getAllConfigurations"],"mappings":"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"}