import {
  usePersistentState
} from "./chunk-ZE7NAT3H.js";
import {
  Form,
  Formik
} from "./chunk-FDDUR3D2.js";
import {
  create4 as create,
  create5 as create2,
  create6 as create3
} from "./chunk-4H2ZWALN.js";
import {
  useIsMobile
} from "./chunk-YRRE432D.js";
import {
  useAppInfo
} from "./chunk-W2Y3XAHI.js";
import {
  useAuth
} from "./chunk-YSYVPEEC.js";
import {
  useNotification
} from "./chunk-73XSTVGM.js";
import {
  Hm,
  I,
  O1,
  R,
  T,
  ll,
  lt,
  ot,
  useIntl,
  wo,
  yo,
  zn
} from "./chunk-5DNSEMX4.js";
import {
  C5
} from "./chunk-URHUI7CZ.js";
import {
  require_jsx_runtime
} from "./chunk-LMPM4PM5.js";
import {
  ct
} from "./chunk-AYMNGYKI.js";
import {
  require_react
} from "./chunk-D3I3COXH.js";
import {
  __toESM
} from "./chunk-LK32TJAX.js";

// node_modules/@strapi/admin/dist/admin/admin/src/components/NpsSurvey.mjs
var import_jsx_runtime = __toESM(require_jsx_runtime(), 1);
var React = __toESM(require_react(), 1);
var FieldWrapper = ct(Hm.Root)`
  height: 3.2rem;
  width: 3.2rem;
  align-items: center;
  justify-content: center;

  > label,
  ~ input {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  > label {
    color: inherit;
    cursor: pointer;
    padding: ${({ theme }) => theme.spaces[2]};
    text-align: center;
    vertical-align: middle;
  }

  &:hover,
  &:focus-within {
    background-color: ${({ theme }) => theme.colors.neutral0};
  }

  &:active,
  &.selected {
    color: ${({ theme }) => theme.colors.primary700};
    background-color: ${({ theme }) => theme.colors.neutral0};
    border-color: ${({ theme }) => theme.colors.primary700};
  }
`;
var delays = {
  postResponse: 90 * 24 * 60 * 60 * 1e3,
  postFirstDismissal: 14 * 24 * 60 * 60 * 1e3,
  postSubsequentDismissal: 90 * 24 * 60 * 60 * 1e3,
  display: 30 * 60 * 1e3
};
var ratingArray = [
  ...Array(11).keys()
];
var checkIfShouldShowSurvey = (settings) => {
  const { enabled, lastResponseDate, firstDismissalDate, lastDismissalDate } = settings;
  if (window.strapi.flags.nps === false) {
    return false;
  }
  if (enabled === false) {
    return false;
  }
  if (lastResponseDate) {
    const timeSinceLastResponse = Date.now() - new Date(lastResponseDate).getTime();
    if (timeSinceLastResponse >= delays.postResponse) {
      return true;
    }
    return false;
  }
  if (lastDismissalDate) {
    const timeSinceLastDismissal = Date.now() - new Date(lastDismissalDate).getTime();
    if (timeSinceLastDismissal >= delays.postSubsequentDismissal) {
      return true;
    }
    return false;
  }
  if (firstDismissalDate) {
    const timeSinceFirstDismissal = Date.now() - new Date(firstDismissalDate).getTime();
    if (timeSinceFirstDismissal >= delays.postFirstDismissal) {
      return true;
    }
    return false;
  }
  return true;
};
var NpsSurvey = () => {
  const isMobile = useIsMobile();
  const { formatMessage } = useIntl();
  const { npsSurveySettings, setNpsSurveySettings } = useNpsSurveySettings();
  const [isFeedbackResponse, setIsFeedbackResponse] = React.useState(false);
  const { toggleNotification } = useNotification();
  const currentEnvironment = useAppInfo("NpsSurvey", (state) => state.currentEnvironment);
  const strapiVersion = useAppInfo("NpsSurvey", (state) => state.strapiVersion);
  const [surveyIsShown, setSurveyIsShown] = React.useState(checkIfShouldShowSurvey(npsSurveySettings));
  const [displaySurvey, setDisplaySurvey] = React.useState(false);
  React.useEffect(() => {
    const displayTime = setTimeout(() => {
      setDisplaySurvey(true);
    }, delays.display);
    return () => {
      clearTimeout(displayTime);
    };
  }, []);
  const { user } = useAuth("NpsSurvey", (auth) => auth);
  if (!displaySurvey) {
    return null;
  }
  if (!surveyIsShown) {
    return null;
  }
  const handleSubmitResponse = async ({ npsSurveyRating, npsSurveyFeedback }) => {
    try {
      const body = {
        email: typeof user === "object" && user.email ? user.email : "",
        rating: npsSurveyRating,
        comment: npsSurveyFeedback,
        environment: currentEnvironment,
        version: strapiVersion ?? void 0,
        license: window.strapi.projectType,
        isHostedOnStrapiCloud: process.env.STRAPI_HOSTING === "strapi.cloud"
      };
      const res = await fetch(`${process.env.STRAPI_ANALYTICS_URL || "https://analytics.strapi.io"}/submit-nps`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        throw new Error("Failed to submit NPS survey");
      }
      setNpsSurveySettings((settings) => ({
        ...settings,
        lastResponseDate: (/* @__PURE__ */ new Date()).toString(),
        firstDismissalDate: null,
        lastDismissalDate: null
      }));
      setIsFeedbackResponse(true);
      setTimeout(() => {
        setSurveyIsShown(false);
      }, 3e3);
    } catch (err) {
      toggleNotification({
        type: "danger",
        message: formatMessage({
          id: "notification.error",
          defaultMessage: "An error occurred"
        })
      });
    }
  };
  const handleDismiss = () => {
    setNpsSurveySettings((settings) => {
      const nextSettings = {
        ...settings,
        lastResponseDate: null
      };
      if (settings.firstDismissalDate) {
        nextSettings.lastDismissalDate = (/* @__PURE__ */ new Date()).toString();
      } else {
        nextSettings.firstDismissalDate = (/* @__PURE__ */ new Date()).toString();
      }
      return nextSettings;
    });
    setSurveyIsShown(false);
  };
  return (0, import_jsx_runtime.jsx)(ll, {
    children: (0, import_jsx_runtime.jsx)(Formik, {
      initialValues: {
        npsSurveyFeedback: "",
        npsSurveyRating: null
      },
      onSubmit: handleSubmitResponse,
      validationSchema: create3({
        npsSurveyFeedback: create(),
        npsSurveyRating: create2().required()
      }),
      children: ({ values, handleChange, setFieldValue, isSubmitting }) => (0, import_jsx_runtime.jsx)(Form, {
        name: "npsSurveyForm",
        children: (0, import_jsx_runtime.jsx)(R, {
          padding: 4,
          position: "fixed",
          bottom: 0,
          left: "50%",
          transform: "translateX(-50%)",
          zIndex: "200",
          minWidth: {
            initial: "100%",
            medium: "50%"
          },
          children: (0, import_jsx_runtime.jsx)(T, {
            hasRadius: true,
            direction: "column",
            padding: 4,
            borderColor: "primary200",
            background: "neutral0",
            shadow: "popupShadow",
            wrap: "wrap",
            children: isFeedbackResponse ? (0, import_jsx_runtime.jsx)(I, {
              fontWeight: "semiBold",
              children: formatMessage({
                id: "app.components.NpsSurvey.feedback-response",
                defaultMessage: "Thank you very much for your feedback!"
              })
            }) : (0, import_jsx_runtime.jsxs)(R, {
              tag: "fieldset",
              width: "100%",
              borderWidth: 0,
              children: [
                (0, import_jsx_runtime.jsxs)(T, {
                  justifyContent: "space-between",
                  width: "100%",
                  gap: 2,
                  children: [
                    (0, import_jsx_runtime.jsx)(R, {
                      marginLeft: "auto",
                      marginRight: "auto",
                      children: (0, import_jsx_runtime.jsx)(I, {
                        fontWeight: "semiBold",
                        tag: "legend",
                        children: formatMessage({
                          id: "app.components.NpsSurvey.banner-title",
                          defaultMessage: "How likely are you to recommend Strapi to a friend or colleague?"
                        })
                      })
                    }),
                    (0, import_jsx_runtime.jsx)(ot, {
                      onClick: handleDismiss,
                      withTooltip: false,
                      label: formatMessage({
                        id: "app.components.NpsSurvey.dismiss-survey-label",
                        defaultMessage: "Dismiss survey"
                      }),
                      type: "button",
                      children: (0, import_jsx_runtime.jsx)(C5, {})
                    })
                  ]
                }),
                isMobile ? (0, import_jsx_runtime.jsx)(R, {
                  marginTop: 2,
                  children: (0, import_jsx_runtime.jsx)(yo, {
                    placeholder: formatMessage({
                      id: "app.components.NpsSurvey.select-rating",
                      defaultMessage: "Select rating"
                    }),
                    onChange: (value) => {
                      setFieldValue("npsSurveyRating", parseInt(value.toString(), 10));
                    },
                    value: values.npsSurveyRating,
                    children: ratingArray.sort((a, b) => b - a).map((number) => {
                      const suffixMessage = number === 0 ? formatMessage({
                        id: "app.components.NpsSurvey.no-recommendation",
                        defaultMessage: "Not at all likely"
                      }) : number === 10 ? formatMessage({
                        id: "app.components.NpsSurvey.happy-to-recommend",
                        defaultMessage: "Extremely likely"
                      }) : "";
                      return (0, import_jsx_runtime.jsxs)(wo, {
                        value: number,
                        children: [
                          number,
                          " ",
                          suffixMessage && `(${suffixMessage})`
                        ]
                      }, number);
                    })
                  })
                }) : (0, import_jsx_runtime.jsxs)(T, {
                  gap: 2,
                  marginTop: 2,
                  marginBottom: 2,
                  justifyContent: "center",
                  children: [
                    (0, import_jsx_runtime.jsx)(I, {
                      variant: "pi",
                      textColor: "neutral600",
                      children: formatMessage({
                        id: "app.components.NpsSurvey.no-recommendation",
                        defaultMessage: "Not at all likely"
                      })
                    }),
                    ratingArray.map((number) => {
                      return (0, import_jsx_runtime.jsx)(FieldWrapper, {
                        name: "npsSurveyRating",
                        className: values.npsSurveyRating === number ? "selected" : void 0,
                        hasRadius: true,
                        background: "primary100",
                        borderColor: "primary200",
                        color: "primary600",
                        position: "relative",
                        cursor: "pointer",
                        children: (0, import_jsx_runtime.jsxs)(Hm.Label, {
                          children: [
                            (0, import_jsx_runtime.jsx)(lt, {
                              children: (0, import_jsx_runtime.jsx)(Hm.Input, {
                                type: "radio",
                                checked: values.npsSurveyRating === number,
                                onChange: (e) => setFieldValue("npsSurveyRating", parseInt(e.target.value, 10)),
                                value: number
                              })
                            }),
                            number
                          ]
                        })
                      }, number);
                    }),
                    (0, import_jsx_runtime.jsx)(I, {
                      variant: "pi",
                      textColor: "neutral600",
                      children: formatMessage({
                        id: "app.components.NpsSurvey.happy-to-recommend",
                        defaultMessage: "Extremely likely"
                      })
                    })
                  ]
                }),
                values.npsSurveyRating !== null && (0, import_jsx_runtime.jsxs)(T, {
                  direction: "column",
                  alignItems: "stretch",
                  children: [
                    (0, import_jsx_runtime.jsx)(R, {
                      marginTop: 2,
                      children: (0, import_jsx_runtime.jsx)(Hm.Label, {
                        fontWeight: "semiBold",
                        fontSize: 2,
                        children: formatMessage({
                          id: "app.components.NpsSurvey.feedback-question",
                          defaultMessage: "Do you have any suggestion for improvements?"
                        })
                      })
                    }),
                    (0, import_jsx_runtime.jsx)(R, {
                      marginTop: 3,
                      marginBottom: 4,
                      width: "100%",
                      children: (0, import_jsx_runtime.jsx)(O1, {
                        id: "npsSurveyFeedback",
                        width: "100%",
                        onChange: handleChange,
                        value: values.npsSurveyFeedback
                      })
                    }),
                    (0, import_jsx_runtime.jsx)(R, {
                      children: (0, import_jsx_runtime.jsx)(zn, {
                        marginBottom: 2,
                        type: "submit",
                        loading: isSubmitting,
                        children: formatMessage({
                          id: "app.components.NpsSurvey.submit-feedback",
                          defaultMessage: "Submit Feedback"
                        })
                      })
                    })
                  ]
                })
              ]
            })
          })
        })
      })
    })
  });
};
function useNpsSurveySettings() {
  const [npsSurveySettings, setNpsSurveySettings] = usePersistentState("STRAPI_NPS_SURVEY_SETTINGS", {
    enabled: true,
    lastResponseDate: null,
    firstDismissalDate: null,
    lastDismissalDate: null
  });
  return {
    npsSurveySettings,
    setNpsSurveySettings
  };
}

export {
  NpsSurvey,
  useNpsSurveySettings
};
//# sourceMappingURL=chunk-TDBDUH6Z.js.map
